{
  "PageID": 14614,
  "PageGuid": "b2152d38-de07-4783-b9a6-2c69a2a8bd72",
  "Title": "Script zur Ermittlung und Update von Dubletten",
  "Content": "Erzeugung temp. Tabelle auf die das Ergebnis ausgeben wird\r\n\r\nCREATE TABLE #tmp\r\n(\r\nbc VARCHAR(50) NULL,\r\ndocid INT NULL,\r\nkst VARCHAR(100) NULL,\r\nbez VARCHAR(500) NULL,\r\nDatum datetime\r\n)\r\n\r\nDECLARE @DWDOCID VARCHAR(100)\r\nDECLARE @BARCODE VARCHAR(100)\r\nDECLARE @KST_KTR_BEZEICHNUNG VARCHAR(100)\r\nDECLARE @KOSTENSTELLE VARCHAR(100)\r\nDECLARE @found int\r\n-----------------------------------------------\r\nDECLARE UPDATE_Cursor CURSOR\r\nFOR SELECT t1.BARCODE\r\nFROM [dwdata].[dbo].[noz] t1\r\nINNER JOIN [dwdata].[dbo].[noz] t2 ON t1.barcode = t2.barcode\r\nWHERE t1.DWDOCID <> t2.DWDOCID\r\nAND t2.BARCODE  > 1\r\nAND t1.BELEGART = '11 - Eingangsrechnungen'\r\nAND ((t1.KST_KTR_BEZEICHNUNG IS NULL OR t2.KST_KTR_BEZEICHNUNG IS NULL) OR (t1.KOSTENSTELLE IS NULL OR t2.KOSTENSTELLE IS NULL))\r\nAND t1.ABGELEGT_AM BETWEEN CONVERT(VARCHAR(10), DATEADD(month, -2, GETDATE()), 104) AND CONVERT(VARCHAR(10), GetDate(), 104)\r\nGROUP BY t1.BARCODE\r\nHAVING ( COUNT(t1.BARCODE) > 1 )\r\n \r\nOPEN UPDATE_Cursor\r\nFETCH NEXT FROM UPDATE_Cursor into @BARCODE\r\n \r\nWHILE @@FETCH_STATUS = 0\r\nBEGIN\r\n             SET @found = (SELECT count(*)\r\n             FROM [dwdata].[dbo].[noz]\r\n             WHERE BARCODE = @BARCODE\r\n             AND @DWDOCID <> DWDOCID)\r\n \r\n             if @found >= 0 \r\n             begin\r\n                   \r\n                    SET @KOSTENSTELLE = (SELECT top 1 KOSTENSTELLE\r\n                    FROM [dwdata].[dbo].[noz]\r\n                    WHERE BARCODE = @BARCODE\r\n                    AND @DWDOCID <> DWDOCID)\r\n                   \r\n                    SET @KST_KTR_BEZEICHNUNG = (SELECT top 1 KST_KTR_BEZEICHNUNG\r\n                    FROM [dwdata].[dbo].[noz]\r\n                    WHERE BARCODE = @BARCODE\r\n                    AND @DWDOCID <> DWDOCID)\r\n \r\n                    SET @DWDOCID = (SELECT top 1 DWDOCID\r\n                    FROM [dwdata].[dbo].[noz]\r\n                    WHERE BARCODE = @BARCODE\r\n                    AND @DWDOCID <> DWDOCID)\r\n \r\n                    INSERT INTO #tmp\r\n                    SELECT BARCODE, DWDOCID, KOSTENSTELLE, KST_KTR_BEZEICHNUNG, ABGELEGT_AM\r\n                    FROM [dwdata].[dbo].[noz]\r\n                    WHERE BARCODE = @BARCODE\r\n                   \r\n             End\r\n        FETCH NEXT FROM UPDATE_Cursor INTO   @BARCODE\r\nEND\r\nCLOSE UPDATE_Cursor\r\nDEALLOCATE UPDATE_Cursor\r\nSELECT * FROM #tmp \r\nDROP TABLE #tmp\r\n\r\nDas Skript, dass das UPDATE der Datensätze vornimmt\r\nDECLARE @DWDOCID VARCHAR(100)\r\nDECLARE @BARCODE VARCHAR(100)\r\nDECLARE @KST_KTR_BEZEICHNUNG VARCHAR(100)\r\nDECLARE @KOSTENSTELLE VARCHAR(100)\r\nDECLARE @found int\r\n-----------------------------------------------\r\nDECLARE UPDATE_Cursor CURSOR\r\nFOR SELECT t1.BARCODE, MAX(t1.DWDOCID) AS DWDOCID\r\nFROM [dwdata].[dbo].[noz] t1\r\nINNER JOIN [dwdata].[dbo].[noz] t2 ON t1.barcode = t2.barcode\r\nWHERE t1.DWDOCID <> t2.DWDOCID\r\nAND t2.BARCODE  > 1\r\nAND t1.BELEGART = '11 - Eingangsrechnungen'\r\nAND ((t1.KST_KTR_BEZEICHNUNG IS NULL OR t2.KST_KTR_BEZEICHNUNG IS NULL) OR (t1.KOSTENSTELLE IS NULL OR t2.KOSTENSTELLE IS NULL))\r\nAND t1.ABGELEGT_AM BETWEEN CONVERT(VARCHAR(10), DATEADD(month, -1, GETDATE()), 104) AND CONVERT(VARCHAR(10), GetDate(), 104)\r\nGROUP BY t1.BARCODE\r\nHAVING ( COUNT(t1.BARCODE) > 1 )\r\n\r\nOPEN UPDATE_Cursor\r\nFETCH NEXT FROM UPDATE_Cursor into @BARCODE, @DWDOCID\r\n \r\nWHILE @@FETCH_STATUS = 0\r\nBEGIN\r\n            \r\n                    SET @KOSTENSTELLE = (SELECT top 1 KOSTENSTELLE\r\n                    FROM [dwdata].[dbo].[noz]\r\n                    WHERE BARCODE = @BARCODE\r\n                    AND @DWDOCID = DWDOCID)\r\n                   \r\n                    SET @KST_KTR_BEZEICHNUNG = (SELECT top 1 KST_KTR_BEZEICHNUNG\r\n                    FROM [dwdata].[dbo].[noz]\r\n                    WHERE BARCODE = @BARCODE\r\n                    AND @DWDOCID = DWDOCID)\r\n\r\nUPDATE [dwdata].[dbo].[noz] \r\nSET  KOSTENSTELLE = @KOSTENSTELLE\r\nWHERE DWDOCID < @DWDOCID\r\nAND BARCODE = @BARCODE\r\nAND KOSTENSTELLE IS NOT NULL\r\n\r\nUPDATE [dwdata].[dbo].[noz] \r\nSET  KST_KTR_BEZEICHNUNG = @KST_KTR_BEZEICHNUNG\r\nWHERE DWDOCID < @DWDOCID\r\nAND BARCODE = @BARCODE\r\nAND KST_KTR_BEZEICHNUNG IS NOT NULL\r\n                   \r\nprint 'MAX DWDOCID' + @DWDOCID +' barcode: ' + @BARCODE + ' kostenstelle: ' + isnull(@KOSTENSTELLE,'LEER') + ' KST_KTR_BEZEICHNUNG: ' + isnull(@KST_KTR_BEZEICHNUNG,'LEER')\r\n            \r\n\r\nFETCH NEXT FROM UPDATE_Cursor INTO   @BARCODE, @DWDOCID\r\nEND\r\nCLOSE UPDATE_Cursor\r\nDEALLOCATE UPDATE_Cursor",
  "Url": "https://services.topfact.de/wiki/pages/view?g=b2152d38-de07-4783-b9a6-2c69a2a8bd72"
}