{
  "PageID": 11355,
  "PageGuid": "969b610f-82cb-46eb-b4ce-bd1d9b724ed6",
  "Title": "Kündigungsparameter übertragen",
  "Content": "Überträgt die Kündigungsparameter an alle untergeordneten Verträge in der gesamten Hirarchie.\r\n\r\n-- =============================================\r\n-- Author: Stefan Bätz, topfact AG\r\n-- Create date: 27.01.2016\r\n-- Description: -\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Sync_TT_Durations]\r\nAS\r\nBEGIN\r\n\r\nCREATE table #tmp (ID INT NULL, ParentID INT NULL, Level INT NULL);\r\n;WITH cte (ID, ParentID, Level) AS\r\n(\r\nSELECT ID, ParentID, 0 AS Level\r\nFROM tblAktivitaet\r\nWHERE (ParentID IS NULL)\r\nUNION ALL\r\nSELECT e.ID, e.ParentID, Level + 1\r\nFROM dbo.tblAktivitaet AS e INNER JOIN cte ON e.ParentID = cte.ID\r\n)\r\n\r\nINSERT INTO #tmp\r\nSELECT ID, ParentID, Level\r\nFROM cte\r\nWHERE Level > 0\r\nORDER BY Level\r\n\r\n--SELECT * from #tmp\r\n\r\nDECLARE @id INT, @parentid INT\r\nDECLARE mycur CURSOR FOR \r\nSELECT ID, ParentID\r\nFROM #tmp\r\nWHERE Level > 0\r\nORDER BY Level;\r\n\r\nOPEN mycur\r\n\r\nFETCH NEXT FROM mycur \r\nINTO @id, @parentid\r\n\r\nWHILE @@FETCH_STATUS = 0\r\nBEGIN\r\n\r\nPRINT 'ParentID: ' + CONVERT(VARCHAR(10),@parentid)\r\nPRINT 'ID: ' + CONVERT(VARCHAR(10),@id)\r\nIF EXISTS(SELECT * FROM tblContract WHERE VorgangID = @parentid)\r\nBEGIN\r\n\r\n--First delete record\r\nDELETE FROM tblContract WHERE VorgangID = @id\r\n\r\n--Second insert with new contractduration\r\nINSERT INTO tblContract\r\n(VorgangID, StartDate, MinEndDate, MinEndDateInterval, MinEndDateType, MinEndDateTime, EndDate, EndDateInterval, EndDateType, EndDateTime, Unlimited, UnlimitedInterval, UnlimitedType, UnlimitedTime, UnlimitedDuration, ActiveProlongation, EarliestCancelationDate, ReminderPeriodDate, ReminderPeriod, Terminated, Comment, DateCreated, DateModified, UserCreated, UserModified)\r\nSELECT \r\n@id, StartDate, MinEndDate, MinEndDateInterval, MinEndDateType, MinEndDateTime, EndDate, EndDateInterval, EndDateType, EndDateTime, Unlimited, UnlimitedInterval, UnlimitedType, UnlimitedTime, UnlimitedDuration, ActiveProlongation, EarliestCancelationDate, ReminderPeriodDate, ReminderPeriod, Terminated, Comment, DateCreated, DateModified, UserCreated, UserModified\r\nFROM\r\ntblContract\r\nWHERE\r\nVorgangID = @parentid\r\n\r\nEND\r\nFETCH NEXT FROM mycur \r\nINTO @id, @parentid\r\nEND \r\nCLOSE mycur;\r\nDEALLOCATE mycur;\r\nDROP TABLE #tmp\r\n\r\nEND\r\n\r\nGO",
  "Url": "https://services.topfact.de/wiki/pages/view?g=969b610f-82cb-46eb-b4ce-bd1d9b724ed6"
}