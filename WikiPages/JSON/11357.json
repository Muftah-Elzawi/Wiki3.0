{
  "PageID": 11357,
  "PageGuid": "1c610be5-bcdb-41ea-b41e-36bdcef51cfc",
  "Title": "Datentransfer CRM Daten",
  "Content": "Überträgt alle CRM Companies in die Firmentabelle von topteam.\r\n-- =============================================\r\n-- Author: Stefan Bätz, topfact AG\r\n-- Create date: 14.10.2015\r\n-- Description: Sync masterdata\r\n-- =============================================\r\nCREATE PROCEDURE [dbo].[Sync_DMS_CRM]\r\nAS\r\nBEGIN\r\n\r\nSET NOCOUNT ON;\r\n\r\nDECLARE\r\n@crmid VARCHAR(50), \r\n@name nvarchar(100),\r\n@group varchar(100),\r\n@street  varchar(100),\r\n@zip varchar(100),\r\n@city varchar(100),\r\n@country varchar(100),\r\n@spec varchar(100),\r\n@mandantid VARCHAR(10),\r\n@status VARCHAR(100)\r\n\r\nDECLARE @mid INT\r\n\r\nDECLARE cur CURSOR FOR \r\nSELECT\r\n[TCaccountnumber],[Name],[DataareaName],[Street],[PostalCode],[City],[Country],\r\nCASE\r\nWHEN [Carrier] = 1 THEN 'Carrier'\r\nWHEN [Shipper] = 1 THEN 'Shipper'\r\nELSE 'Other' END AS typ,\r\nCASE \r\nWHEN [DataareaName] = 'TRANSPOREON' THEN '101'\r\nWHEN [DataareaName] = 'TRANSPOREON Group' THEN '101'\r\nWHEN [DataareaName] = 'MERCAREON' THEN '102'\r\nWHEN [DataareaName] = 'TICONTRACT' THEN '103'\r\nEND AS dataareaid,\r\n'Free for all' as COMPANY_STATUS\r\nFROM\r\n[MSSQL.HQ.TP.NIL].[TP_CRM_MSCRM].[dbo].[VIEW_TRANSPOREON_DMS_ACCOUNT]\r\nWHERE\r\n(Name IS NOT NULL) \r\nAND (TCaccountnumber IS NOT NULL OR LEN(TCaccountnumber)>0);\r\n\r\nOPEN cur\r\n\r\nFETCH NEXT FROM cur \r\nINTO @crmid, @name,@group,@street,@zip,@city,@country,@spec,@mandantid,@status\r\n\r\nWHILE @@FETCH_STATUS = 0\r\nBEGIN\r\nSELECT @mid = MandantID FROM tblMandant WHERE (Nummer = @mandantid);\r\nIF EXISTS (SELECT * FROM topteam.dbo.tblFirma WHERE CRMID = @crmid)\r\nBEGIN\r\nUPDATE\r\ntopteam.dbo.tblFirma\r\nSET\r\nName1 = @name, \r\nGroupName = @group, \r\nStrasse = @street, \r\nPLZ = @zip, \r\nOrt = @city, \r\nLKZ = @country, \r\nfk_tblFirmenspezifikation = (\r\nCASE\r\nWHEN @spec = 'Carrier' THEN 1\r\nWHEN @spec = 'Shipper' THEN 7\r\nWHEN @spec = 'Supplier' THEN 2\r\nWHEN @spec = 'Corporate' THEN 3\r\nWHEN @spec = 'Institutions & Public Authority' THEN 4\r\nWHEN @spec = 'Other' THEN 5\r\nWHEN @spec = 'Vendor' THEN 7\r\nELSE NULL END),\r\nfk_tblFirmenStatus = (\r\nCASE\r\nWHEN @status = 'Free for all' THEN 1\r\nWHEN @status = 'Blocked for all' THEN 2\r\nELSE NULL END),\r\nMandantID = @mid,\r\nDateModified = GETDATE()\r\nWHERE\r\n(CRMID = @crmid)\r\nEND\r\nELSE\r\nBEGIN\r\nINSERT INTO topteam.dbo.tblFirma\r\n(CRMID, Suchwort, Name1, GroupName, Strasse, PLZ, Ort, LKZ, MandantID, \r\nfk_tblFirmenspezifikation, fk_tblFirmenStatus, DateInserted)\r\nVALUES\r\n(@crmid,@crmid,@name,@group,@street,@zip,@city,@country,@mid,\r\nCASE\r\nWHEN @spec = 'Carrier' THEN 1\r\nWHEN @spec = 'Shipper' THEN 7\r\nWHEN @spec = 'Supplier' THEN 2\r\nWHEN @spec = 'Corporate' THEN 3\r\nWHEN @spec = 'Institutions & Public Authority' THEN 4\r\nWHEN @spec = 'Other' THEN 5\r\nWHEN @spec = 'Vendor' THEN 7\r\nELSE NULL END, \r\nCASE\r\nWHEN @status = 'Free for all' THEN 1\r\nWHEN @status = 'Blocked for all' THEN 2\r\nELSE NULL END,\r\nGETDATE())\r\nEND\r\n\r\nFETCH NEXT FROM cur \r\nINTO @crmid, @name,@group,@street,@zip,@city,@country,@spec,@mandantid,@status\r\nEND \r\nCLOSE cur;\r\nDEALLOCATE cur;\r\n\r\nEND\r\n\r\nGO",
  "Url": "https://services.topfact.de/wiki/pages/view?g=1c610be5-bcdb-41ea-b41e-36bdcef51cfc"
}