{
  "PageID": 17127,
  "PageGuid": "c7162254-e2c6-4df8-95be-1b480ddb0cab",
  "Title": "topfact6 Benutzer für Aufgaben in MyWork bereitstellen",
  "Content": "Mit dem nachfolgendem Skript können die in topfact6 angelegten Benutzer in die topteam Datenbank importiert werden.\r\nDas Skript aktualisiert auch abgeänderte Einträge.\r\nDamit ein Benutzer in der topteam-Tabelle aktualisiert wird, muss jedoch ein DateModified Datum in der topfact6 Benutzertabelle sein, das größer oder gleich dem DateModified in der tblAnsprechpartner ist. Dabei wird nicht nur auf das Datum geschaut, selbst die Uhrzeit wird dabei mit eingebezogen.\r\n\r\n\r\n-- Skript zum aktualisieren der topteam Benutzer\r\n-- topteam Benutzer werden für den Aufgabenversand benötigt\r\n \r\n-- !!ACHTUNG!!\r\n--\r\n-- WIRD BEI EINEM topfact6 Benutzer DER BENUTZERNAME ODER VORNAME GEÄNDERT,\r\n-- DANN WIRD DER BENUTZER GELÖSCHT UND NEU ANGELGT. \r\n-- DER BENUTZER WIRD DANN NICHT GEUPDATET!!!\r\n-- DAS VERÄNDERT DIE GUID DES USERS IN DEM topteam-SYSTEM.\r\n--\r\n-- !!ACHTUNG!!  \r\n \r\n \r\n \r\n-- Variablen für das Eintragen/Updaten/Löschen\r\nDECLARE \r\n       @ttID INT, @Firma INT, @Vorname VARCHAR(100), @Nachname VARCHAR(100), \r\n       @Username VARCHAR(100), @Email VARCHAR(100), @PwdHash VARCHAR(MAX), \r\n       @inaktiv INT,  @IsTopserv BIT, @IsTopservAdmin BIT, @DMSUser VARCHAR(100), \r\n       @DMSPwd VARCHAR(MAX), @Guid VARCHAR(50), @DateCreated DATETIME, @UserCreated VARCHAR(50),\r\n       @DateModified DATETIME, @UserModified VARCHAR(50), @tf6DateModified DATETIME, @ttDateModified DATETIME\r\n \r\nDECLARE c CURSOR\r\nFOR\r\n       SELECT\r\n             tt.ID,  \r\n             tf6.Vorname, \r\n             tf6.Nachname,\r\n             tf6.Benutzername,\r\n             tf6.EMail, \r\n             tf6.Passwort,\r\n             (CASE tf6.Aktiv \r\n                    WHEN 0 THEN 1 \r\n                    WHEN 1 THEN 0 \r\n             END) AS inaktiv, \r\n             tf6.IsAdministrator,\r\n             tf6.ArchivBenutzername,\r\n             tf6.ArchivPasswort,\r\n             tf6.DateModified,\r\n             tt.DateModified\r\n       FROM topfact6.dbo.TF_Benutzer tf6\r\n       LEFT JOIN topteam.dbo.tblAnsprechpartner tt\r\n       ON tf6.Benutzername = tt.Username AND tf6.Vorname = tt.Vorname\r\n \r\n-- Erstellungsinformationsvariablen definieren\r\nSELECT @DateCreated = GETDATE(), @UserCreated = 'admin', @DateModified = GETDATE(), @UserModified = 'admin'\r\n \r\n-- Einstellungen initialisieren\r\nSELECT @Firma = 1, @IsTopserv = 1\r\n \r\n-- Aktualiseren von vorhanden Usern bei Änderungen in topfact6\r\n-- Eintragen von neuangelegten Usern in topfact6\r\nOPEN c\r\nFETCH NEXT FROM c INTO @ttID, @Vorname, @Nachname, @Username, @Email, @PwdHash,  @inaktiv, @IsTopservAdmin, @DMSUser, @DMSPwd, @tf6DateModified, @ttDateModified\r\n \r\nWHILE @@FETCH_STATUS = 0\r\nBEGIN\r\n \r\n       -- Eintragen eines neuangelegten topfact6 Users\r\n       IF @ttID IS NULL\r\n       BEGIN\r\n             SELECT @Guid = CONVERT(VARCHAR(50), NEWID())\r\n \r\n             --PRINT @Username + ' NEUER Benutzer - GUID: ' + @Guid + ' <-- wird eingefügt'\r\n             INSERT INTO topteam.dbo.tblAnsprechpartner(fk_tblFirma, Nachname, Vorname, \r\n                    Username, geschDWMail, PasswortHash, inaktiv, IsTopserv, IsTopservAdmin,\r\n                    DMSUsername, DMSPassword, UserGuid, DateCreated, UserCreated)\r\n             VALUES(@Firma, @Nachname, @Vorname, @Username, @Email, @PwdHash, @inaktiv, \r\n                    @IsTopserv, @IsTopservAdmin, @DMSUser, @DMSPwd, @Guid, @DateCreated, @UserCreated)\r\n       END\r\n \r\n \r\n \r\n       -- Updaten eines geänderten topfact6 Users\r\n       IF @ttID IS NOT NULL AND ((@tf6DateModified >= @ttDateModified) OR ((@tf6DateModified IS NOT NULL) AND (@ttDateModified IS NULL)))\r\n       BEGIN\r\n             --PRINT @Username + ' VORHANDENER Benutzer <-- wird geupdatet'\r\n \r\n             UPDATE \r\n                    topteam.dbo.tblAnsprechpartner\r\n             SET    \r\n                    fk_tblFirma = @Firma, Nachname = @Nachname, geschDWMail = @Email, PasswortHash = @PwdHash, \r\n                    inaktiv = @inaktiv, IsTopservAdmin = @IsTopservAdmin, DMSUsername = @DMSUser, \r\n                    DMSPassword = @DMSPwd, DateModified = @DateModified, UserModified = @UserModified\r\n             WHERE\r\n                    ID = @ttID\r\n       END\r\n \r\n       FETCH NEXT FROM c INTO @ttID, @Vorname, @Nachname, @Username, @Email, @PwdHash,  @inaktiv, @IsTopservAdmin, @DMSUser, @DMSPwd, @tf6DateModified, @ttDateModified\r\nEND\r\nCLOSE c\r\nDEALLOCATE c\r\n \r\n-- Entfernen der gelöschten topfact6 Benutzer\r\nDECLARE c CURSOR\r\nFOR\r\n       SELECT\r\n             tt.ID\r\n       FROM topteam.dbo.tblAnsprechpartner tt\r\n       LEFT JOIN topfact6.dbo.TF_Benutzer tf6\r\n       ON tf6.Benutzername = tt.Username AND tf6.Vorname = tt.Vorname\r\n       WHERE\r\n             tf6.UserId IS NULL\r\n \r\nOPEN c\r\nFETCH NEXT FROM c INTO @ttID\r\n \r\nWHILE @@FETCH_STATUS = 0\r\nBEGIN\r\n \r\n       --PRINT CONVERT(VARCHAR(100),@ttID) + ' <-- zu löschen'\r\n       DELETE FROM topteam.dbo.tblAnsprechpartner\r\n       WHERE ID = @ttID\r\n       FETCH NEXT FROM c INTO @ttID\r\n \r\nEND\r\nCLOSE c\r\nDEALLOCATE c\r\n \r\n Daniel Paulus, 29.08.2019",
  "Url": "https://services.topfact.de/wiki/pages/view?g=c7162254-e2c6-4df8-95be-1b480ddb0cab"
}