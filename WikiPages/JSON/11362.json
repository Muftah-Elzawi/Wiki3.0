{
  "PageID": 11362,
  "PageGuid": "7fd23ed5-9c48-4ed6-978a-ba23d2125076",
  "Title": "Update Companies Duplettenprüfung",
  "Content": "Vergleicht die Felder ERPID und CRMID und findet gleich Firmen.\r\nAlle Firmen die beiden Felder haben bleiben bestehen, Felder mit CRMID weren entfernt.\r\nVerträge werden umgeschlüsselt.\r\n\r\nSET NOCOUNT ON;\r\n\r\nDECLARE @id int, @name nvarchar(250), @erpid varchar(100), @crmid nvarchar(100);\r\nDECLARE @id2 int, @name2 nvarchar(250), @erpid2 varchar(100), @crmid2 nvarchar(100);\r\n\r\n--Firmen ermitteln die beide Kennzeichen haben\r\n-- ERPID ist gefüllt, CRMID ist gefüllt\r\nDECLARE mycur CURSOR FOR \r\nSELECT\r\nID, Name1, ERPID, CRMID\r\nFROM\r\ntblfirma\r\nWHERE\r\nLEN(ISNULL(ERPID,''))>0 AND LEN(ISNULL(CRMID,''))>0;\r\n\r\nOPEN mycur\r\n\r\nFETCH NEXT FROM mycur \r\nINTO @id, @name, @erpid, @crmid\r\n\r\nWHILE @@FETCH_STATUS = 0\r\nBEGIN\r\n\r\nSELECT @id2 = NULL, @name2 = NULL, @erpid2 = NULL, @crmid2 = NULL\r\n    PRINT 'Master: ' + @name + ', ERPID: ' + @erpid + ', CRMID: ' + @crmid\r\n\r\n--Suchen welche Firmen eine existierende CRM haben und KEINE ERPID\r\nIF EXISTS (SELECT * FROM tblFirma WHERE LEN(ISNULL(ERPID,''))=0 AND CRMID = @crmid)\r\n\r\nSELECT\r\n@id2 = id, \r\n@name2 = name1,\r\n@erpid2 = ERPID,\r\n@crmid2 = CRMID \r\nFROM\r\ntblFirma \r\nWHERE\r\nLEN(ISNULL(ERPID,''))=0 AND CRMID = @crmid\r\nPRINT 'Client: ' + ISNULL(@name2,'-') + ', ERPID: ' + ISNULL(@erpid2,'-') + ', CRMID: ' + ISNULL(@crmid2,'-')\r\nIF ISNULL(@id2,'')=0\r\nSET @id2 = 0\r\n\r\nPRINT 'Dupl. FirmaID: ' + CONVERT(VARCHAR(10),@id2)\r\n\r\nIF @id2 > 0\r\nBEGIN\r\n--BACKUP zu löschende Firma\r\nINSERT INTO tblFirmaBackup\r\nSELECT * FROM tblFirma WHERE ID = @id2\r\n\r\n--Vertrag umschlüsseln\r\nUPDATE tblAktivitaet\r\nSET \r\nfk_tblFirma = @id,\r\nERPID = @erpid,\r\nCRMID = @crmid\r\nWHERE\r\nfk_tblFirma = @id2\r\n\r\n----Firma löschen\r\nDELETE FROM tblFirma WHERE ID = @id2\r\nEND\r\nPRINT '-----------------------------------'\r\n\r\n    FETCH NEXT FROM mycur \r\n    INTO @id, @name, @erpid, @crmid\r\nEND \r\nCLOSE mycur;\r\nDEALLOCATE mycur;",
  "Url": "https://services.topfact.de/wiki/pages/view?g=7fd23ed5-9c48-4ed6-978a-ba23d2125076"
}