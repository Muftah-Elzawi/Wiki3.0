<div>Überträgt die Kündigungsparameter an alle untergeordneten Verträge in der gesamten Hirarchie.</div><div><br /></div><div>-- =============================================</div><div>-- Author:<span class="Apple-tab-span" style="white-space:pre">		</span>Stefan Bätz, topfact AG</div><div>-- Create date: 27.01.2016</div><div>-- Description:<span class="Apple-tab-span" style="white-space:pre">	</span>-</div><div>-- =============================================</div><div>CREATE PROCEDURE [dbo].[Sync_TT_Durations]</div><div>AS</div><div>BEGIN</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">	</span>CREATE table #tmp (ID INT NULL, ParentID INT NULL, Level INT NULL);</div><div><span class="Apple-tab-span" style="white-space:pre">	</span></div><div><span class="Apple-tab-span" style="white-space:pre">	</span>;WITH cte (ID, ParentID, Level) AS</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>(</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>SELECT ID, ParentID, 0 AS Level</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>FROM tblAktivitaet</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>WHERE (ParentID IS NULL)</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>UNION ALL</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>SELECT e.ID, e.ParentID, Level + 1</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>FROM dbo.tblAktivitaet AS e INNER JOIN cte ON e.ParentID = cte.ID</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>)</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">	</span>INSERT INTO #tmp</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>SELECT ID, ParentID, Level</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>FROM cte</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>WHERE Level &gt; 0</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>ORDER BY Level</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">	</span>--SELECT * from #tmp</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">	</span>DECLARE @id INT, @parentid INT</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>DECLARE mycur CURSOR FOR&nbsp;</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>SELECT ID, ParentID</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>FROM #tmp</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>WHERE Level &gt; 0</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>ORDER BY Level;</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">	</span>OPEN mycur</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">	</span>FETCH NEXT FROM mycur&nbsp;</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>INTO @id, @parentid</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">	</span>WHILE @@FETCH_STATUS = 0</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>BEGIN</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">		</span>PRINT 'ParentID: ' + CONVERT(VARCHAR(10),@parentid)</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>PRINT 'ID: ' + CONVERT(VARCHAR(10),@id)</div><div><span class="Apple-tab-span" style="white-space:pre">	</span></div><div><span class="Apple-tab-span" style="white-space:pre">		</span>IF EXISTS(SELECT * FROM tblContract WHERE VorgangID = @parentid)</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>BEGIN</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">			</span>--First delete record</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>DELETE FROM tblContract WHERE VorgangID = @id</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">			</span>--Second insert with new contractduration</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>INSERT INTO tblContract</div><div><span class="Apple-tab-span" style="white-space:pre">				</span>(VorgangID, StartDate, MinEndDate, MinEndDateInterval, MinEndDateType, MinEndDateTime, EndDate, EndDateInterval, EndDateType, EndDateTime, Unlimited, UnlimitedInterval, UnlimitedType, UnlimitedTime, UnlimitedDuration, ActiveProlongation, EarliestCancelationDate, ReminderPeriodDate, ReminderPeriod, Terminated, Comment, DateCreated, DateModified, UserCreated, UserModified)</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>SELECT&nbsp;</div><div><span class="Apple-tab-span" style="white-space:pre">				</span>@id, StartDate, MinEndDate, MinEndDateInterval, MinEndDateType, MinEndDateTime, EndDate, EndDateInterval, EndDateType, EndDateTime, Unlimited, UnlimitedInterval, UnlimitedType, UnlimitedTime, UnlimitedDuration, ActiveProlongation, EarliestCancelationDate, ReminderPeriodDate, ReminderPeriod, Terminated, Comment, DateCreated, DateModified, UserCreated, UserModified</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>FROM</div><div><span class="Apple-tab-span" style="white-space:pre">				</span>tblContract</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>WHERE</div><div><span class="Apple-tab-span" style="white-space:pre">				</span>VorgangID = @parentid</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">		</span>END</div><div><span class="Apple-tab-span" style="white-space:pre">	</span></div><div><span class="Apple-tab-span" style="white-space:pre">					</span></div><div><span class="Apple-tab-span" style="white-space:pre">		</span>FETCH NEXT FROM mycur&nbsp;</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>INTO @id, @parentid</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>END&nbsp;</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>CLOSE mycur;</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>DEALLOCATE mycur;</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>DROP TABLE #tmp</div><div><br /></div><div>END</div><div><br /></div><div>GO</div><div><br /></div><div><br /></div>