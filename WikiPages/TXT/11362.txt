<div>Vergleicht die Felder ERPID und CRMID und findet gleich Firmen.</div><div>Alle Firmen die beiden Felder haben bleiben bestehen, Felder mit CRMID weren entfernt.</div><div>Verträge werden umgeschlüsselt.</div><div><br /></div><div>SET NOCOUNT ON;</div><div><br /></div><div>DECLARE @id int, @name nvarchar(250), @erpid varchar(100), @crmid nvarchar(100);</div><div>DECLARE @id2 int, @name2 nvarchar(250), @erpid2 varchar(100), @crmid2 nvarchar(100);</div><div><br /></div><div>--Firmen ermitteln die beide Kennzeichen haben</div><div>-- ERPID ist gefüllt, CRMID ist gefüllt</div><div>DECLARE mycur CURSOR FOR&nbsp;</div><div>SELECT</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>ID, Name1, ERPID, CRMID</div><div>FROM</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>tblfirma</div><div>WHERE</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>LEN(ISNULL(ERPID,''))&gt;0 AND LEN(ISNULL(CRMID,''))&gt;0;</div><div><br /></div><div>OPEN mycur</div><div><br /></div><div>FETCH NEXT FROM mycur&nbsp;</div><div>INTO @id, @name, @erpid, @crmid</div><div><br /></div><div>WHILE @@FETCH_STATUS = 0</div><div>BEGIN</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">	</span>SELECT @id2 = NULL, @name2 = NULL, @erpid2 = NULL, @crmid2 = NULL</div><div><span class="Apple-tab-span" style="white-space:pre">	</span></div><div>&nbsp; &nbsp; PRINT 'Master: ' + @name + ', ERPID: ' + @erpid + ', CRMID: ' + @crmid</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">	</span>--Suchen welche Firmen eine existierende CRM haben und KEINE ERPID</div><div><span class="Apple-tab-span" style="white-space:pre">	</span>IF EXISTS (SELECT * FROM tblFirma WHERE LEN(ISNULL(ERPID,''))=0 AND CRMID = @crmid)</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">		</span>SELECT</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>@id2 = id,&nbsp;</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>@name2 = name1,</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>@erpid2 = ERPID,</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>@crmid2 = CRMID&nbsp;</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>FROM</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>tblFirma&nbsp;</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>WHERE</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>LEN(ISNULL(ERPID,''))=0 AND CRMID = @crmid</div><div><span class="Apple-tab-span" style="white-space:pre">				</span></div><div><span class="Apple-tab-span" style="white-space:pre">		</span>PRINT 'Client: ' + ISNULL(@name2,'-') + ', ERPID: ' + ISNULL(@erpid2,'-') + ', CRMID: ' + ISNULL(@crmid2,'-')</div><div><span class="Apple-tab-span" style="white-space:pre">		</span></div><div><span class="Apple-tab-span" style="white-space:pre">		</span>IF ISNULL(@id2,'')=0</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>SET @id2 = 0</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">		</span>PRINT 'Dupl. FirmaID: ' + CONVERT(VARCHAR(10),@id2)</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">		</span>IF @id2 &gt; 0</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>BEGIN</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>--BACKUP zu löschende Firma</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>INSERT INTO tblFirmaBackup</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>SELECT * FROM tblFirma WHERE ID = @id2</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">			</span>--Vertrag umschlüsseln</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>UPDATE tblAktivitaet</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>SET&nbsp;</div><div><span class="Apple-tab-span" style="white-space:pre">				</span>fk_tblFirma = @id,</div><div><span class="Apple-tab-span" style="white-space:pre">				</span>ERPID = @erpid,</div><div><span class="Apple-tab-span" style="white-space:pre">				</span>CRMID = @crmid</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>WHERE</div><div><span class="Apple-tab-span" style="white-space:pre">				</span>fk_tblFirma = @id2</div><div><br /></div><div><span class="Apple-tab-span" style="white-space:pre">			</span>----Firma löschen</div><div><span class="Apple-tab-span" style="white-space:pre">			</span>DELETE FROM tblFirma WHERE ID = @id2</div><div><span class="Apple-tab-span" style="white-space:pre">		</span>END</div><div><span class="Apple-tab-span" style="white-space:pre">			</span></div><div><span class="Apple-tab-span" style="white-space:pre">		</span>PRINT '-----------------------------------'</div><div><br /></div><div>&nbsp; &nbsp; FETCH NEXT FROM mycur&nbsp;</div><div>&nbsp; &nbsp; INTO @id, @name, @erpid, @crmid</div><div>END&nbsp;</div><div>CLOSE mycur;</div><div>DEALLOCATE mycur;</div>