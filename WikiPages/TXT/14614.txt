<div><strong>Erzeugung temp. Tabelle au</strong><strong>f die das Ergebnis ausgeben wird</strong></div><div><br /></div><div>CREATE TABLE #tmp</div><div>(</div><div> bc VARCHAR(50) NULL,</div><div> docid INT NULL,</div><div> kst VARCHAR(100) NULL,</div><div> bez VARCHAR(500) NULL,</div><div> Datum datetime</div><div>)</div><div><br /></div><div>DECLARE @DWDOCID VARCHAR(100)</div><div>DECLARE @BARCODE VARCHAR(100)</div><div>DECLARE @KST_KTR_BEZEICHNUNG VARCHAR(100)</div><div>DECLARE @KOSTENSTELLE VARCHAR(100)</div><div>DECLARE @found int</div><div>-----------------------------------------------</div><div>DECLARE UPDATE_Cursor CURSOR</div><div>FOR SELECT t1.BARCODE</div><div>FROM [dwdata].[dbo].[noz] t1</div><div>INNER JOIN [dwdata].[dbo].[noz] t2 ON t1.barcode = t2.barcode</div><div>WHERE t1.DWDOCID &lt;&gt; t2.DWDOCID</div><div>AND t2.BARCODE &nbsp;&gt; 1</div><div>AND t1.BELEGART = '11 - Eingangsrechnungen'</div><div>AND ((t1.KST_KTR_BEZEICHNUNG IS NULL OR t2.KST_KTR_BEZEICHNUNG IS NULL) OR (t1.KOSTENSTELLE IS NULL OR t2.KOSTENSTELLE IS NULL))</div><div>AND t1.ABGELEGT_AM BETWEEN CONVERT(VARCHAR(10), DATEADD(month, -2, GETDATE()), 104) AND CONVERT(VARCHAR(10), GetDate(), 104)</div><div>GROUP BY t1.BARCODE</div><div>HAVING ( COUNT(t1.BARCODE) &gt; 1 )</div><div>&nbsp;</div><div>OPEN UPDATE_Cursor</div><div>FETCH NEXT FROM UPDATE_Cursor into @BARCODE</div><div>&nbsp;</div><div>WHILE @@FETCH_STATUS = 0</div><div>BEGIN</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SET @found = (SELECT count(*)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FROM [dwdata].[dbo].[noz]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHERE BARCODE = @BARCODE</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AND @DWDOCID &lt;&gt; DWDOCID)</div><div>&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if @found &gt;= 0&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;begin</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SET @KOSTENSTELLE = (SELECT top 1 KOSTENSTELLE</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM [dwdata].[dbo].[noz]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE BARCODE = @BARCODE</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AND @DWDOCID &lt;&gt; DWDOCID)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SET @KST_KTR_BEZEICHNUNG = (SELECT top 1 KST_KTR_BEZEICHNUNG</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM [dwdata].[dbo].[noz]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE BARCODE = @BARCODE</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AND @DWDOCID &lt;&gt; DWDOCID)</div><div>&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SET @DWDOCID = (SELECT top 1 DWDOCID</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM [dwdata].[dbo].[noz]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE BARCODE = @BARCODE</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AND @DWDOCID &lt;&gt; DWDOCID)</div><div>&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INSERT INTO #tmp</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SELECT BARCODE, DWDOCID, KOSTENSTELLE, KST_KTR_BEZEICHNUNG, ABGELEGT_AM</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM [dwdata].[dbo].[noz]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE BARCODE = @BARCODE</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;End</div><div>&nbsp; &nbsp; &nbsp; &nbsp; FETCH NEXT FROM UPDATE_Cursor INTO &nbsp; @BARCODE</div><div>END</div><div>CLOSE UPDATE_Cursor</div><div>DEALLOCATE UPDATE_Cursor<br /><br /></div><div>SELECT * FROM #tmp <br /><br /></div><div>DROP TABLE #tmp</div> <p><br /></p><p><strong>Das Skript, dass das UPDATE der Datens√§tze vornimmt</strong><br /></p><div><div>DECLARE @DWDOCID VARCHAR(100)</div><div>DECLARE @BARCODE VARCHAR(100)</div><div>DECLARE @KST_KTR_BEZEICHNUNG VARCHAR(100)</div><div>DECLARE @KOSTENSTELLE VARCHAR(100)</div><div>DECLARE @found int</div><div>-----------------------------------------------</div><div>DECLARE UPDATE_Cursor CURSOR</div><div>FOR SELECT t1.BARCODE, MAX(t1.DWDOCID) AS DWDOCID</div><div>FROM [dwdata].[dbo].[noz] t1</div><div>INNER JOIN [dwdata].[dbo].[noz] t2 ON t1.barcode = t2.barcode</div><div>WHERE t1.DWDOCID &lt;&gt; t2.DWDOCID</div><div>AND t2.BARCODE &nbsp;&gt; 1</div><div>AND t1.BELEGART = '11 - Eingangsrechnungen'</div><div>AND ((t1.KST_KTR_BEZEICHNUNG IS NULL OR t2.KST_KTR_BEZEICHNUNG IS NULL) OR (t1.KOSTENSTELLE IS NULL OR t2.KOSTENSTELLE IS NULL))</div><div>AND t1.ABGELEGT_AM BETWEEN CONVERT(VARCHAR(10), DATEADD(month, -1, GETDATE()), 104) AND CONVERT(VARCHAR(10), GetDate(), 104)</div><div>GROUP BY t1.BARCODE</div><div>HAVING ( COUNT(t1.BARCODE) &gt; 1 )</div><div><br /></div><div>OPEN UPDATE_Cursor</div><div>FETCH NEXT FROM UPDATE_Cursor into @BARCODE, @DWDOCID</div><div>&nbsp;</div><div>WHILE @@FETCH_STATUS = 0</div><div>BEGIN</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SET @KOSTENSTELLE = (SELECT top 1 KOSTENSTELLE</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM [dwdata].[dbo].[noz]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE BARCODE = @BARCODE</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AND @DWDOCID = DWDOCID)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SET @KST_KTR_BEZEICHNUNG = (SELECT top 1 KST_KTR_BEZEICHNUNG</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM [dwdata].[dbo].[noz]</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE BARCODE = @BARCODE</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AND @DWDOCID = DWDOCID)</div><div><br /></div><div> UPDATE [dwdata].[dbo].[noz]&nbsp;</div><div> SET &nbsp;KOSTENSTELLE = @KOSTENSTELLE</div><div> WHERE DWDOCID &lt; @DWDOCID</div><div> AND BARCODE = @BARCODE</div><div> AND KOSTENSTELLE IS NOT NULL</div><div><br /></div><div> UPDATE [dwdata].[dbo].[noz]&nbsp;</div><div> SET &nbsp;KST_KTR_BEZEICHNUNG = @KST_KTR_BEZEICHNUNG</div><div> WHERE DWDOCID &lt; @DWDOCID</div><div> AND BARCODE = @BARCODE</div><div> AND KST_KTR_BEZEICHNUNG IS NOT NULL</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>print 'MAX DWDOCID' + @DWDOCID +' barcode: ' + @BARCODE + ' kostenstelle: ' + isnull(@KOSTENSTELLE,'LEER') + ' KST_KTR_BEZEICHNUNG: ' + isnull(@KST_KTR_BEZEICHNUNG,'LEER')</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div><br /></div><div>FETCH NEXT FROM UPDATE_Cursor INTO &nbsp; @BARCODE, @DWDOCID</div><div>END</div><div>CLOSE UPDATE_Cursor</div><div>DEALLOCATE UPDATE_Cursor</div></div><div></div>